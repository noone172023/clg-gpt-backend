<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLGPT Frontend Tester</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 20px; }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="email"], select { width: 98%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .status-box { padding: 15px; margin-top: 20px; border-radius: 4px; font-weight: bold; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .dashboard-view { display: none; padding: 20px; border: 1px dashed #007bff; margin-top: 20px; }
        textarea { width: 98%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CLGPT API Tester (Frontend Mockup)</h1>
        <p>Backend URL: <strong id="api-url"></strong></p>
        <hr>

        <div id="auth-view" class="main-view">
            
            <h2>1. Register User (POST /register)</h2>
            <form id="registerForm">
                <div>
                    <label for="regRole">Role:</label>
                    <select id="regRole" required>
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                        <option value="placement_cell">Placement Cell</option>
                    </select>
                </div>
                <div>
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" value="faculty1@gmail.com" required>
                </div>
                <div>
                    <label for="regPassword">Password:</label>
                    <input type="password" id="regPassword" value="password123" required>
                </div>
                <div>
                    <label for="regFullName">Full Name:</label>
                    <input type="text" id="regFullName" value="F. One" required>
                </div>
                <div>
                    <label for="regUsername">Username:</label>
                    <input type="text" id="regUsername" value="faculty_one" required>
                </div>
                <div>
                    <label for="regBranch">Branch (CS, AI, or IS):</label>
                    <select id="regBranch" required>
                        <option value="CS">CS</option>
                        <option value="AI">AI</option>
                        <option value="IS">IS</option>
                    </select>
                </div>
                <div>
                    <label for="regUSN">USN (e.g., 4cb23a065 or 10-digit Employee ID):</label>
                    <input type="text" id="regUSN" value="EMP4567890" required>
                </div>
                <div>
                    <label for="regStudyYear">Study Year (1-4):</label>
                    <input type="number" id="regStudyYear" value="0" min="0" max="4" required>
                </div>
                <button type="submit">Register</button>
            </form>
            <div id="registerStatus" class="status-box" style="display:none;"></div>
            
            <hr>

            <h2>2. Login User (POST /login)</h2>
            <form id="loginForm">
                <div>
                    <label for="logEmail">Email:</label>
                    <input type="email" id="logEmail" value="faculty1@gmail.com" required>
                </div>
                <div>
                    <label for="logPassword">Password:</label>
                    <input type="password" id="logPassword" value="password123" required>
                </div>
                <button type="submit">Login</button>
            </form>
            <div id="loginStatus" class="status-box" style="display:none;"></div>

        </div>

        <div id="general-chat-component" style="display: none;">
            <h3>üí¨ Role-Contextual Chat (POST /gemini-chat)</h3>
            <form id="chatForm">
                <input type="hidden" id="chatUserEmail">
                <div>
                    <label for="chatQuery">Ask the CLGPT Assistant:</label>
                    <textarea id="chatQuery" placeholder="E.g., What are the core topics in AI Branch?" required></textarea>
                </div>
                <button type="submit">Send Query</button>
            </form>
            <div id="chatStatus" class="status-box" style="display:none;"></div>
            <div id="chatResponse" class="status-box"></div>
        </div>
        
        <div id="student_general" class="dashboard-view">
            <h2>Student Dashboard (Year 1/2)</h2>
            <p>Welcome, **<span id="sg-name">User</span>**! Access General Notes and Academic Schedule.</p>
            <button onclick="getStudentNotes('sg-branch')">Get Notes Link (GET /student/notes-link)</button>
            <div id="sg-notes-status" class="status-box"></div>
            <div id="sg-schedule-status" class="status-box"></div>
        </div>

        <div id="student_placements" class="dashboard-view">
            <h2>Student Placement Dashboard (Year 3/4)</h2>
            <p>Welcome, **<span id="sp-name">User</span>**! Check Placement Jobs and Schedules.</p>
            <button onclick="getStudentSchedule('sp-usn')">Get Schedule Link (GET /student/schedule)</button>
            <button onclick="getJobPosts()">View Latest Job Posts (GET /placement/jobs)</button>
            <div id="sp-schedule-status" class="status-box"></div>
            <div id="sp-jobs-status" class="status-box"></div>
        </div>

        <div id="faculty_dashboard" class="dashboard-view">
            <h2>Faculty Dashboard (<span id="f-branch">CS</span>)</h2>
            <p>Welcome, **<span id="f-name">Faculty</span>**! Your access is limited to your departmental context for chat.</p>
            <p>Your branch context: <strong id="f-branch-context"></strong></p>
        </div>

        <div id="placement_dashboard" class="dashboard-view">
            <h2>Placement Cell Dashboard</h2>
            <p>Welcome, **<span id="pc-name">Placement Officer</span>**! Full oversight of placement activities.</p>
            <button onclick="getJobPosts()">View All Job Posts (GET /placement/jobs)</button>
            <div id="pc-jobs-status" class="status-box"></div>
        </div>
        
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = "https://clg-gpt.onrender.com"; 
        // Example: "https://clg-gpt.onrender.com";

        // IMPORTANT: Replace the placeholder above with your actual live Render URL.
        document.getElementById('api-url').textContent = API_BASE_URL;
        let currentUser = {}; // Global object to hold user data (email, role, branch, etc.)

        // --- UTILITY FUNCTIONS ---

        function setStatus(elementId, message, type) {
            const statusBox = document.getElementById(elementId);
            statusBox.style.display = 'block';
            statusBox.className = `status-box status-${type}`;
            statusBox.innerHTML = message;
        }

        // ‚≠ê NEW: FUNCTION TO SWITCH DASHBOARD VIEWS ‚≠ê
        function showView(viewId) {
            document.querySelectorAll('.main-view, .dashboard-view, #general-chat-component').forEach(el => {
                el.style.display = 'none';
            });
            
            if (viewId === 'auth-view') {
                document.getElementById('auth-view').style.display = 'block';
            } else {
                document.getElementById(viewId).style.display = 'block';
                document.getElementById('general-chat-component').style.display = 'block';
                
                // Populate dashboard details
                document.getElementById('chatUserEmail').value = currentUser.email;

                if (viewId === 'student_general') {
                    document.getElementById('sg-name').textContent = currentUser.full_name;
                    document.getElementById('sg-branch').textContent = currentUser.branch;
                } else if (viewId === 'student_placements') {
                    document.getElementById('sp-name').textContent = currentUser.full_name;
                    document.getElementById('sp-usn').textContent = currentUser.usn;
                } else if (viewId === 'faculty_dashboard') {
                    document.getElementById('f-name').textContent = currentUser.full_name;
                    document.getElementById('f-branch').textContent = currentUser.branch;
                    document.getElementById('f-branch-context').textContent = `Role: ${currentUser.role}, Branch: ${currentUser.branch}`;
                } else if (viewId === 'placement_dashboard') {
                    document.getElementById('pc-name').textContent = currentUser.full_name;
                }
            }
        }


        // --- API HANDLERS ---

        async function registerUser(event) {
            event.preventDefault();
            const url = `${API_BASE_URL}/register`;
            const data = {
                role: document.getElementById('regRole').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                full_name: document.getElementById('regFullName').value,
                username: document.getElementById('regUsername').value,
                branch: document.getElementById('regBranch').value,
                usn: document.getElementById('regUSN').value,
                study_year: parseInt(document.getElementById('regStudyYear').value),
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    setStatus('registerStatus', `Status: SUCCESS (HTTP ${response.status})<br>Message: ${result.message}`, 'success');
                } else {
                    setStatus('registerStatus', `Status: ERROR (HTTP ${response.status})<br>Detail: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                setStatus('registerStatus', `Status: ERROR<br>"message": "Network error occurred during request.", "error": "Failed to fetch"`, 'error');
            }
        }

        async function loginUser(event) {
            event.preventDefault();
            const url = `${API_BASE_URL}/login`;
            const data = {
                email: document.getElementById('logEmail').value,
                password: document.getElementById('logPassword').value,
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    setStatus('loginStatus', `Status: SUCCESS (HTTP ${response.status})<br>Dashboard Key: ${result.dashboard}`, 'success');
                    
                    // ‚≠ê LOGIN SUCCESS HANDLER - ROUTING TO CORRECT DASHBOARD ‚≠ê
                    currentUser = result; // Store all returned user data globally
                    currentUser.full_name = currentUser.full_name || "User";
                    showView(result.dashboard); // Load the specific dashboard based on API response
                } else {
                    setStatus('loginStatus', `Status: ERROR (HTTP ${response.status})<br>Detail: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                setStatus('loginStatus', `Status: ERROR<br>"message": "Network error occurred during request.", "error": "Failed to fetch"`, 'error');
            }
        }

        async function chatWithGemini(event) {
            event.preventDefault();
            const url = `${API_BASE_URL}/gemini-chat`;
            const query = document.getElementById('chatQuery').value;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_email: currentUser.email, query: query })
                });

                const result = await response.json();

                if (response.ok) {
                    setStatus('chatResponse', `**Gemini Response:**<br>${result.response}`, 'success');
                } else {
                    setStatus('chatResponse', `**Gemini Error:**<br>Detail: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                setStatus('chatResponse', `**Chat Error:**<br>"message": "Network error occurred during request.", "error": "Failed to fetch"`, 'error');
            }
        }

        // Utility Endpoint Handlers (Mocked to show functionality)
        async function getStudentNotes() {
            const url = `${API_BASE_URL}/student/notes-link/${currentUser.branch}`;
            try {
                const response = await fetch(url);
                const result = await response.json();
                const statusBox = document.getElementById('sg-notes-status');
                statusBox.className = 'status-box status-success';
                statusBox.innerHTML = `**Notes Link (${currentUser.branch}):** <a href="${result.link}" target="_blank">${result.link}</a>`;
            } catch (error) {
                setStatus('sg-notes-status', 'Could not fetch notes link.', 'error');
            }
        }
        
        async function getStudentSchedule() {
            const url = `${API_BASE_URL}/student/schedule/${currentUser.usn}`;
             try {
                const response = await fetch(url);
                const result = await response.json();
                const statusBox = document.getElementById('sp-schedule-status');
                statusBox.className = 'status-box status-success';
                statusBox.innerHTML = `**Schedule Link:** <a href="${result.link}" target="_blank">${result.link}</a>`;
            } catch (error) {
                setStatus('sp-schedule-status', 'Could not fetch schedule link.', 'error');
            }
        }
        
        async function getJobPosts() {
            const url = `${API_BASE_URL}/placement/jobs`;
            const statusId = currentUser.role === 'placement_cell' ? 'pc-jobs-status' : 'sp-jobs-status';
            
            try {
                const response = await fetch(url);
                const result = await response.json();
                
                let jobList = result.jobs.map(job => 
                    `<li>**${job.title}** at ${job.company} (${job.salary})</li>`
                ).join('');
                
                setStatus(statusId, `**Latest Job Posts:** <ul>${jobList}</ul>`, 'success');
            } catch (error) {
                setStatus(statusId, 'Could not fetch job posts.', 'error');
            }
        }


        // --- EVENT LISTENERS AND INITIALIZATION ---
        document.getElementById('registerForm').addEventListener('submit', registerUser);
        document.getElementById('loginForm').addEventListener('submit', loginUser);
        document.getElementById('chatForm').addEventListener('submit', chatWithGemini);
        
        // Start on the authentication view
        showView('auth-view');
    </script>
</body>
</html>